# MongoDB Driver

The **MongoDB Driver** enables data synchronization from MongoDB to S3 parquet or iceberg. It supports both **Full Refresh** and **CDC (Change Data Capture)** modes.

---

## Supported Modes

| Mode                          | Description                                                     |
| ----------------------------- | --------------------------------------------------------------- |
| **Full Refresh**              | Fetches the complete dataset from MongoDB.                      |
| **CDC (Change Data Capture)** | Read MongoDB change streams in real time |

---

## Setup & Configuration

Clone/build your driver binary and create three JSON config files in your project directory:

| File                   | Purpose                                                        |
| ---------------------- | -------------------------------------------------------------- |
| **`source.json`**      | MongoDB connection details                                     |
| **`streams.json`**     | List of collections & fields to sync (generated by _Discover_) |
| **`destination.json`** | Destination writer configuration                               |

### Config File (`source.json`)

Add MongoDB credentials in the following format (see the [docs](https://olake.io/docs/connectors/mongodb/config) for details):

```json
{
  "hosts": ["host1:27017", "host2:27017", "host3:27017"],
  "username": "test",
  "password": "test",
  "authdb": "admin",
  "replica_set": "rs0",
  "read_preference": "secondaryPreferred",
  "srv": false,
  "database": "database",
  "max_threads": 50,
  "default_mode": "cdc",
  "backoff_retry_count": 2,
  "partition_strategy": ""
}
```

---

## Commands

### Discover Command

Generates JSON content for `streams.json`, defining the schema of the collections to be synced.

```bash
./build.sh driver-mongodb discover \
  --config /mongodb/config/source.json
```

---

### Configure Catalog

Before running _Sync_, adjust the generated `streams.json`:

1. **Remove unnecessary streams** from `selected_streams`.
2. **Add partitions** by editing `partition_regex`. Refer the partitioning docs for [AWS S3](https://olake.io/docs/writers/s3/partitioning) and [Apache Iceberg](https://olake.io/docs/writers/iceberg/partitioning) here.
3. **Set sync properties** for every stream you wish to sync:

   ```json
   "sync_mode": "cdc",
   "cursor_field": "<cursor field from available_cursor_fields>"
   ```

**Final catalog example**

```json
{
  "selected_streams": {
    "namespace": [
      {
        "partition_regex": "",
        "stream_name": "incr",
        "normalization": false
      }
    ]
  },
  "streams": [
    {
      "stream": {
        "name": "incr2",
        "namespace": "incr",
        "type_schema": { ...  },
        "supported_sync_modes": [
          "full_refresh",
          "cdc"
         ],
        "source_defined_primary_key": [
          "_id"
          ],
        "available_cursor_fields": [],
        "sync_mode": "cdc"
      }
    }
  ]
}
```

---

### Writer File

Defines the configuration for the destination. The `normalization` flag triggers level-1 JSON flattening.

#### Local (Parquet)

```json
{
  "type": "PARQUET",
  "writer": {
    "normalization": true,
    "local_path": "./config/config"
  }
}
```

#### Amazon S3 (Parquet)

```json
{
  "type": "PARQUET",
  "writer": {
    "normalization": false,
    "s3_bucket": "olake",
    "s3_region": "",
    "s3_access_key": "",
    "s3_secret_key": "",
    "s3_path": ""
  }
}
```

#### AWS S3 + Glue (Iceberg)

```json
{
  "type": "ICEBERG",
  "writer": {
    "normalization": false,
    "s3_path": "s3://{bucket_name}/{path_prefix}/",
    "aws_region": "ap-south-1",
    "aws_access_key": "XXX",
    "aws_secret_key": "XXX",
    "database": "olake_iceberg",
    "grpc_port": 50051,
    "server_host": "localhost"
  }
}
```

#### Local Test (JDBC + MinIO)

```json
{
  "type": "ICEBERG",
  "writer": {
    "catalog_type": "jdbc",
    "jdbc_url": "jdbc:postgresql://localhost:5432/iceberg",
    "jdbc_username": "iceberg",
    "jdbc_password": "password",
    "normalization": false,
    "iceberg_s3_path": "s3a://warehouse",
    "s3_endpoint": "http://localhost:9000",
    "s3_use_ssl": false,
    "s3_path_style": true,
    "aws_access_key": "admin",
    "aws_secret_key": "password",
    "iceberg_db": "olake_iceberg"
  }
}
```

_For a detailed writer overview, see the [Destinations & Catalog docs](https://olake.io/docs/writers/iceberg/catalog/overview)._

---

### Sync Command

Run a sync without state:

```bash
./build.sh driver-mongodb sync \
  --config /mongodb/config/source.json \
  --catalog /mongodb/config/streams.json \
  --destination /mongodb/config/destination.json
```

Resume a sync from a saved state:

```bash
./build.sh driver-mongodb sync \
  --config /mongodb/config/source.json \
  --catalog /mongodb/config/streams.json \
  --destination /mongodb/config/destination.json \
  --state /mongodb/config/state.json
```

---

## State File

`state.json` lets you resume a sync from the last processed checkpoint:

```json
{
  "type": "STREAM",
  "streams": [
    {
      "stream": "twitter.test_stream",
      "namespace": "twitter",
      "sync_mode": "",
      "state": { "_data": "826811EEFE000000022B0429296E1404", "chunks": [] }
    }
  ]
}
```

---

## Performance Benchmarks

### Speed Comparison: Full Load Performance

For a 230 million-row collection (664.81 GB) from [Twitter data](https://archive.org/details/archiveteam-twitter-stream-2017-11):

| Tool                    | Full Load Time   | Performance    |
| ----------------------- | ---------------- | -------------- |
| **Olake**               | **46 mins**      | X times faster |
| **Fivetran**            | 4 h 39 m (279 m) | 6× slower      |
| **Airbyte**             | 16 h (960 m)     | 20× slower     |
| **Debezium (Embedded)** | 11.65 h (699 m)  | 15× slower     |

### Incremental Sync Performance

| Tool                    | Incremental Sync Time | Records/s  | Performance    |
| ----------------------- | --------------------- | ---------- | -------------- |
| **Olake**               | **28.3 s**            | 35 694 r/s | X times faster |
| **Fivetran**            | 3 m 10 s              | 5 260 r/s  | 6.7× slower    |
| **Airbyte**             | 12 m 44 s             | 1 308 r/s  | 27.3× slower   |
| **Debezium (Embedded)** | 12 m 44 s             | 1 308 r/s  | 27.3× slower   |

---

## Testing Infrastructure

**VM:** `Standard_D64as_v5`

| Resource | Value         |
| -------- | ------------- |
| vCPUs    | 64            |
| Memory   | 256 GiB RAM   |
| Storage  | 250 GB shared |

---

## MongoDB Setup

A 3-node replica set:

- **1 Primary** – handles all writes
- **2 Secondaries** – replicate from primary

---

## Additional Resources

- [MongoDB Connector Docs](https://olake.io/docs/connectors/mongodb/overview)
