# Postgres Driver

The **Postgres Driver** enables data synchronization from PostgreSQL to any supported destination. It supports both **Full Refresh** and **CDC (Change Data Capture)** modes.

## Supported Modes

| Mode                          | Description                                                      |
| ----------------------------- | ---------------------------------------------------------------- |
| **Full Refresh**              | Fetches the complete dataset from Postgres.                      |
| **CDC (Change Data Capture)** | Tracks and syncs incremental changes from Postgres in real time. |

---

## Setup & Configuration

Create three JSON config files in your project directory:

| File                   | Purpose                                                   |
| ---------------------- | --------------------------------------------------------- |
| **`source.json`**      | PostgreSQL connection details                             |
| **`streams.json`**     | List of tables & fields to sync (generated by _Discover_) |
| **`destination.json`** | Destination writer configuration                          |

### Config File (`source.json`)

Add Postgres credentials in the following format (see the [docs](https://olake.io/docs/connectors/postgres/config) for details):

```json
{
  "host": "postgres-host",
  "port": 5432,
  "database": "postgres_db",
  "username": "postgres_user",
  "password": "postgres_pass",
  "jdbc_url_params": {},
  "ssl": {
    "mode": "disable"
  },
  "update_method": {
    "replication_slot": "postgres_slot",
    "intial_wait_time": 10
  },
  "reader_batch_size": 100000,
  "default_mode": "cdc",
  "max_threads": 50,
  "split-region": ""
}
```

---

## Commands

### Discover Command

Generates JSON content for `streams.json`, defining the schema of the tables to be synced.

```bash
./build.sh driver-postgres discover \
  --config /postgres/configs/source.json
```

---

### Configure Catalog

Before running _Sync_, adjust the generated `streams.json`:

1. **Remove unnecessary streams** from `selected_streams`.
2. **Add partitions** by editing `partition_regex`. Refer the partitioning docs for [AWS S3](https://olake.io/docs/writers/s3/partitioning) and [Apache Iceberg](https://olake.io/docs/writers/iceberg/partitioning) here.
3. **Add a split column** (usually the primary key) for chunked full-load reads.
4. **Set sync properties** for every stream you wish to sync:

   ```json
   "sync_mode": "cdc",
   "cursor_field": "<cursor field from available_cursor_fields>"
   ```

**Final catalog example**

```json
{
  "selected_streams": {
    "public": [
      {
        "partition_regex": "",
        "stream_name": "table_1",
        "normalization": false
      }
    ]
  },
  "streams": [
    {
      "stream": {
        "name": "table_1",
        "namespace": "public",
        "type_schema": {
          "properties": {
             "...": "..."
          }
        },
        "supported_sync_modes": ["full_refresh", "cdc"],
        "source_defined_primary_key": [<primary_key>],
        "available_cursor_fields": [<cursor_field>],
        "sync_mode": "cdc"
      }
    }
  ]
}
```

---

### Writer File

Defines the configuration for the destination. The `normalization` flag triggers level-1 JSON flattening.

#### Local (Parquet)

```json
{
  "type": "PARQUET",
  "writer": {
    "normalization": true,
    "local_path": "./configs/reader"
  }
}
```

#### Amazon S3 (Parquet)

```json
{
  "type": "PARQUET",
  "writer": {
    "normalization": false,
    "s3_bucket": "olake",
    "s3_region": "",
    "s3_access_key": "",
    "s3_secret_key": "",
    "s3_path": ""
  }
}
```

#### AWS S3 + Glue (Iceberg)

```json
{
  "type": "ICEBERG",
  "writer": {
    "normalization": false,
    "s3_path": "s3://{bucket_name}/{path_prefix}/",
    "aws_region": "ap-south-1",
    "aws_access_key": "XXX",
    "aws_secret_key": "XXX",
    "database": "olake_iceberg",
    "grpc_port": 50051,
    "server_host": "localhost"
  }
}
```

#### Local Test (JDBC + MinIO)

```json
{
  "type": "ICEBERG",
  "writer": {
    "catalog_type": "jdbc",
    "jdbc_url": "jdbc:postgresql://localhost:5432/iceberg",
    "jdbc_username": "iceberg",
    "jdbc_password": "password",
    "normalization": false,
    "iceberg_s3_path": "s3a://warehouse",
    "s3_endpoint": "http://localhost:9000",
    "s3_use_ssl": false,
    "s3_path_style": true,
    "aws_access_key": "admin",
    "aws_secret_key": "password",
    "iceberg_db": "olake_iceberg"
  }
}
```

_For a detailed writer overview, see the [Destinations & Catalog docs](https://olake.io/docs/writers/iceberg/catalog/overview)._

---

### Sync Command

Run a sync without state:

```bash
./build.sh driver-postgres sync \
  --config /postgres/configs/source.json \
  --catalog /postgres/configs/streams.json \
  --destination /postgres/configs/destination.json
```

Resume a sync from a saved state:

```bash
./build.sh driver-postgres sync \
  --config /postgres/configs/source.json \
  --catalog /postgres/configs/streams.json \
  --destination /postgres/configs/destination.json \
  --state /postgres/configs/state.json
```

---

## State File

`state.json` lets you resume a sync from the last processed checkpoint:

```json
{
  "type": "GLOBAL",
  "global": {
    "state": {
      "lsn": "5F4/A400B6D7"
    },
    "streams": ["public.table_1"]
  },
  "streams": [
    {
      "stream": "table_1",
      "namespace": "public",
      "sync_mode": "",
      "state": {
        "chunks": []
      }
    }
  ]
}
```

---

## Additional Resources

- [PostgreSQL Connector Docs](https://olake.io/docs/connectors/postgres/overview)
